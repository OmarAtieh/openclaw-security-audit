name: OpenClaw Security Audit CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Manual trigger for testing

jobs:
  test-tool:
    runs-on: ubuntu-latest
    name: Test Security Audit Tool
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Test imports
        run: |
          echo "Testing module imports..."
          python3 -c "import sys; sys.path.insert(0, '.'); from modules.base import Finding; print('✅ base module OK')"
          python3 -c "import sys; sys.path.insert(0, '.'); from modules.config_scanner import ConfigScanner; print('✅ config_scanner OK')"
          python3 -c "import sys; sys.path.insert(0, '.'); from modules.skill_scanner import SkillScanner; print('✅ skill_scanner OK')"
          python3 -c "import sys; sys.path.insert(0, '.'); from modules.cve_mapper import CVEMapper; print('✅ cve_mapper OK')"
          python3 -c "import sys; sys.path.insert(0, '.'); from modules.channel_auditor import ChannelAuditor; print('✅ channel_auditor OK')"
          
      - name: Test CLI help
        run: |
          echo "Testing --help flag..."
          python3 audit.py --help
          echo "✅ Help output successful"
          
      - name: Test version flag
        run: |
          echo "Testing --version flag..."
          python3 audit.py --version
          echo "✅ Version output successful"
          
      - name: Lint with pylint (optional)
        continue-on-error: true
        run: |
          pip install pylint
          pylint audit.py modules/*.py --disable=all --enable=E,F --exit-zero
          
      - name: Create test OpenClaw directory
        run: |
          mkdir -p test-openclaw
          echo '{"test": "config"}' > test-openclaw/openclaw.json
          
      - name: Test scan on mock directory
        run: |
          echo "Running audit on test directory..."
          python3 audit.py test-openclaw --output-json test-report.json --output-md test-report.md
          echo "✅ Scan completed"
          
      - name: Verify outputs
        run: |
          ls -lh test-report.json test-report.md
          echo "JSON report preview:"
          head -20 test-report.json
          echo ""
          echo "Markdown report preview:"
          head -30 test-report.md
          
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            test-report.json
            test-report.md
          retention-days: 7
          
      - name: Success summary
        run: |
          echo "::notice::✅ All CI checks passed!"
          echo "::notice::Tool is ready for use"
